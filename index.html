<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Ch·∫•m c√¥ng V·ªã X∆∞a Qu√°n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    body {
      background: #f0f2f5;
      padding-top: 40px;
    }

    .card {
      border-radius: 16px;
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- ƒêƒÉng nh·∫≠p -->
    <div class="card shadow p-4 mb-4" id="loginCard">
      <h4>üîê ƒêƒÉng nh·∫≠p</h4>
      <div class="row">
        <div class="col-12 col-md-4 mb-2"><input id="loginCode" class="form-control" placeholder="M√£ nh√¢n vi√™n"></div>
        <div class="col-12 col-md-4 mb-2"><input type="password" id="loginPin" class="form-control"
            placeholder="M·∫≠t kh·∫©u/PIN">
        </div>
        <div class="col-12 col-md-4 mb-2"><button onclick="login()" class="btn btn-primary w-100">ƒêƒÉng nh·∫≠p</button>
        </div>
      </div>
    </div>

    <!-- T·∫°o t√†i kho·∫£n (ch·ªâ admin) -->
    <div class="card shadow p-4 mb-4 d-none" id="createUserCard">
      <h4>‚ûï T·∫°o t√†i kho·∫£n m·ªõi (ch·ªâ Admin)</h4>
      <div class="row g-2">
        <div class="col-12 col-md-3 mb-2"><input id="newCode" class="form-control" placeholder="M√£ NV"></div>
        <div class="col-12 col-md-3 mb-2"><input type="password" id="newPin" class="form-control"
            placeholder="M·∫≠t kh·∫©u"></div>
        <div class="col-12 col-md-3 mb-2">
          <select id="newRole" class="form-select">
            <option value="staff">Nh√¢n vi√™n</option>
            <option value="admin">Qu·∫£n tr·ªã</option>
          </select>
        </div>
        <div class="col-12 col-md-3 mb-2"><button onclick="createUser()" class="btn btn-success w-100">T·∫°o</button>
        </div>
      </div>
    </div>

    <!-- Danh s√°ch nh√¢n vi√™n (ch·ªâ admin) -->
    <div class="card shadow p-4 mb-4 d-none" id="userListCard">
      <h4>üë• Danh s√°ch nh√¢n vi√™n</h4>
      <div class="table-responsive">
        <table class="table table-bordered mt-3">
          <thead class="table-light">
            <tr>
              <th>M√£ NV</th>
              <th>Quy·ªÅn</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody id="userListTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Modal s·ª≠a t√†i kho·∫£n -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editUserModalLabel">S·ª≠a t√†i kho·∫£n</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input id="editUserCode" class="form-control mb-2" placeholder="M√£ NV" readonly>
            <input id="editUserPin" class="form-control mb-2" placeholder="M·∫≠t kh·∫©u m·ªõi">
            <select id="editUserRole" class="form-select">
              <option value="staff">Nh√¢n vi√™n</option>
              <option value="admin">Qu·∫£n tr·ªã</option>
            </select>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            <button type="button" class="btn btn-success" onclick="saveEditUser()">L∆∞u</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Ch·∫•m c√¥ng b√π -->
    <div class="modal fade" id="addRecordModal" tabindex="-1" aria-labelledby="addRecordModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addRecordModalLabel">‚ûï Ch·∫•m c√¥ng b√π</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <input id="manualCode" class="form-control" placeholder="M√£ NV">
            </div>
            <div class="mb-2">
              <label>Check-in:</label>
              <input id="manualCheckIn" type="datetime-local" class="form-control">
            </div>
            <div class="mb-2">
              <label>Check-out:</label>
              <input id="manualCheckOut" type="datetime-local" class="form-control">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            <button type="button" class="btn btn-success" onclick="addManualRecord()">L∆∞u</button>
          </div>
        </div>
      </div>
    </div>

    <!-- L·ªãch s·ª≠ ƒëƒÉng nh·∫≠p -->
    <div id="loginHistoryCard" class="card shadow p-4 mt-4 d-none">
      <h5>üïì L·ªãch s·ª≠ ƒëƒÉng nh·∫≠p</h5>
      <div class="table-responsive">
        <table class="table table-bordered mt-3">
          <thead class="table-light">
            <tr>
              <th>M√£ NV</th>
              <th>Th·ªùi gian ƒëƒÉng nh·∫≠p</th>
              <th>V·ªã tr√≠ (lat, lon)</th>
            </tr>
          </thead>
          <tbody id="loginLogsTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Giao di·ªán ch√≠nh -->
    <div class="card shadow p-4 mb-4 d-none" id="mainCard">
      <h4>üìÖ Ch·∫•m c√¥ng</h4>
      <div class="row mb-3">
        <div class="col-md-4"><strong>M√£ NV:</strong> <span id="currentUser"></span></div>
        <div class="col-md-4"><strong>Quy·ªÅn:</strong> <span id="currentRole"></span></div>
        <div class="col-md-4 text-end">
          <button onclick="logout()" class="btn btn-outline-danger btn-sm">ƒêƒÉng xu·∫•t</button>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-6"><button onclick="checkIn()" class="btn btn-success w-100">‚úÖ Check-in</button></div>
        <div class="col-md-6"><button onclick="checkOut()" class="btn btn-danger w-100">‚õî Check-out</button></div>
      </div>
      <div id="adminControls" class="d-none mb-3">
        <div class="row mb-2" id="monthPickerRow">
          <div class="col-auto">
            <input type="month" id="monthPicker" class="form-control" value="">
          </div>
        </div>
        <button onclick="exportToExcel()" class="btn btn-primary">üì• Xu·∫•t Excel</button>
      </div>
      <div id="summaryTableContainer" class="mb-3"></div>
      <div class="table-responsive">
        <table class="table table-bordered mt-3" id="attendanceTable">
          <thead class="table-light">
            <tr>
              <th>M√£ NV</th>
              <th>Check-in</th>
              <th>Check-out</th>
              <th>T·ªïng gi·ªù</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const SHEET_API = 'https://sheetdb.io/api/v1/27oigr7cnxz2f';
    const SHEET_API_LOGINLOGS = 'https://sheetdb.io/api/v1/27oigr7cnxz2f';

    // ƒêƒÉng nh·∫≠p
    function login() {
      const code = document.getElementById('loginCode').value.trim();
      const pin = document.getElementById('loginPin').value.trim();
      // Fix c·ª©ng t√†i kho·∫£n admin
      if (code === 'admin' && pin === 'admin') {
        localStorage.setItem('session', JSON.stringify({ code: 'admin', role: 'admin' }));
        showMainUI();
        return;
      }
      fetch(`${SHEET_API}/search?code=${code}&pin=${pin}`)
        .then(res => res.json())
        .then(data => {
          if (data.length === 0) {
            alert("Sai m√£ ho·∫∑c m·∫≠t kh·∫©u!");
            return;
          }
          // L∆∞u log ƒëƒÉng nh·∫≠p
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              pos => saveLoginLog(code, pos.coords.latitude, pos.coords.longitude),
              err => saveLoginLog(code, null, null)
            );
          } else {
            saveLoginLog(code, null, null);
          }
          localStorage.setItem('session', JSON.stringify({ code, role: data[0].role }));
          showMainUI();
        });
    }

    // T·∫°o t√†i kho·∫£n m·ªõi (ch·ªâ admin)
    function createUser() {
      const code = document.getElementById('newCode').value.trim();
      const pin = document.getElementById('newPin').value.trim();
      const role = document.getElementById('newRole').value;
      if (!code || !pin) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin!");
      fetch(`${SHEET_API}/search?code=${code}`)
        .then(res => res.json())
        .then(data => {
          if (data.length > 0) {
            alert("M√£ NV ƒë√£ t·ªìn t·∫°i!");
          } else {
            fetch(SHEET_API, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ data: [{ code, pin, role }] })
            })
              .then(res => res.json())
              .then(() => {
                alert('‚úÖ T·∫°o th√†nh c√¥ng!');
                renderTable();
              })
              .catch(() => alert('L·ªói khi t·∫°o t√†i kho·∫£n!'));
          }
        });
    }

    function logout() {
      localStorage.removeItem('session');
      location.reload();
    }

    function getSession() {
      return JSON.parse(localStorage.getItem('session'));
    }

    // L·∫•y t·∫•t c·∫£ b·∫£n ghi ch·∫•m c√¥ng
    function getRecords(callback) {
      fetch(SHEET_API)
        .then(res => res.json())
        .then(data => callback(data));
    }

    // Check-in
    function checkIn() {
      const session = getSession();
      getRecords(data => {
        // Ki·ªÉm tra n·∫øu ƒë√£ c√≥ b·∫£n ghi check-in ch∆∞a check-out
        const hasOpenCheckIn = data.some(r => r.code === session.code && r.checkIn && !r.checkOut);
        if (hasOpenCheckIn) {
          alert('B·∫°n ƒë√£ check-in, vui l√≤ng check-out tr∆∞·ªõc khi check-in ti·∫øp!');
          return;
        }
        const checkIn = new Date().toISOString();
        fetch(SHEET_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data: [{ code: session.code, checkIn }] })
        })
          .then(res => res.json())
          .then(() => {
            renderTable();
            alert('‚úÖ Check-in th√†nh c√¥ng!');
          })
          .catch(() => alert('L·ªói khi check-in!'));
      });
    }

    // Check-out
    function checkOut() {
      const session = getSession();
      getRecords(data => {
        // T√¨m b·∫£n ghi check-in ch∆∞a check-out
        const record = data.reverse().find(r => r.code === session.code && r.checkIn && !r.checkOut);
        if (!record) {
          alert("Ch∆∞a check-in!");
          return;
        }
        record.checkOut = new Date().toISOString();
        fetch(`${SHEET_API}/code/${record.code}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data: [{ checkOut: record.checkOut }] })
        })
          .then(res => res.json())
          .then(() => {
            renderTable();
            alert('‚õî Check-out th√†nh c√¥ng!');
          })
          .catch(() => alert('L·ªói khi check-out!'));
      });
    }

    // Hi·ªÉn th·ªã b·∫£ng ch·∫•m c√¥ng
    function renderTable() {
      const tbody = document.querySelector("#attendanceTable tbody");
      tbody.innerHTML = "";
      const session = getSession();
      getRecords(data => {
        let records = data;
        if (session.role !== 'admin') {
          records = records.filter(r => r.code === session.code);
        }
        records.forEach(r => {
          const row = tbody.insertRow();
          row.insertCell().textContent = r.code;
          row.insertCell().textContent = r.checkIn ? new Date(r.checkIn).toLocaleString() : '';
          row.insertCell().textContent = r.checkOut ? new Date(r.checkOut).toLocaleString() : '';
          row.insertCell().textContent =
            (r.checkIn && r.checkOut) ?
              ((new Date(r.checkOut) - new Date(r.checkIn)) / 3600000).toFixed(2) + " gi·ªù" : '';
        });
        // N·∫øu l√† nh√¢n vi√™n, th√™m d√≤ng t·ªïng s·ªë gi·ªù v√†o cu·ªëi b·∫£ng
        if (session.role !== 'admin') {
          const userMonthPicker = document.getElementById('userMonthPicker');
          let year, month;
          if (userMonthPicker && userMonthPicker.value) {
            [year, month] = userMonthPicker.value.split('-').map(Number);
          } else {
            const now = new Date();
            year = now.getFullYear();
            month = now.getMonth() + 1;
          }
          const monthRecords = filterRecordsByMonth(records, year, month);
          let total = 0;
          monthRecords.forEach(r => {
            if (r.checkIn && r.checkOut) {
              total += (new Date(r.checkOut) - new Date(r.checkIn)) / 3600000;
            }
          });
          const row = tbody.insertRow();
          row.insertCell().textContent = '';
          row.insertCell().textContent = '';
          row.insertCell().textContent = 'T·ªïng c·ªông';
          row.insertCell().textContent = total.toFixed(2) + ' gi·ªù';
        }
      });
    }

    function filterRecordsByCurrentMonth(records) {
      const now = new Date();
      const month = now.getMonth();
      const year = now.getFullYear();
      return records.filter(r => {
        if (!r.checkIn) return false;
        const d = new Date(r.checkIn);
        return d.getMonth() === month && d.getFullYear() === year;
      });
    }

    // L·ªçc theo th√°ng/nƒÉm b·∫•t k·ª≥
    function filterRecordsByMonth(records, year, month) {
      return records.filter(r => {
        if (!r.checkIn) return false;
        const d = new Date(r.checkIn);
        return d.getMonth() + 1 === month && d.getFullYear() === year;
      });
    }

    // Xu·∫•t Excel (ch·ªâ admin)
    function exportToExcel() {
      const session = getSession();
      if (!session || session.role !== 'admin') return;
      const monthPicker = document.getElementById('monthPicker');
      let year, month;
      if (monthPicker && monthPicker.value) {
        [year, month] = monthPicker.value.split('-').map(Number);
      } else {
        const now = new Date();
        year = now.getFullYear();
        month = now.getMonth() + 1;
      }
      getRecords(data => {
        // L·ªçc d·ªØ li·ªáu theo th√°ng/nƒÉm ƒë√£ ch·ªçn
        const monthRecords = filterRecordsByMonth(data, year, month);

        // T·∫°o d·ªØ li·ªáu chi ti·∫øt t·ª´ng ng√†y
        const excelData = monthRecords.map(r => ({
          'M√£ NV': r.code,
          'Ng√†y': r.checkIn ? new Date(r.checkIn).toLocaleDateString() : '',
          'Check-in': r.checkIn ? new Date(r.checkIn).toLocaleTimeString() : '',
          'Check-out': r.checkOut ? new Date(r.checkOut).toLocaleTimeString() : '',
          'T·ªïng gi·ªù': (r.checkIn && r.checkOut)
            ? ((new Date(r.checkOut) - new Date(r.checkIn)) / 3600000).toFixed(2)
            : ''
        }));

        // Xu·∫•t file
        const ws = XLSX.utils.json_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, `ChiTiet_${month}_${year}`);
        XLSX.writeFile(wb, `chamcong_chitiet_${month}_${year}.xlsx`);
      });
    }

    function renderUserList() {
      const tbody = document.getElementById('userListTable');
      tbody.innerHTML = '';
      getRecords(data => {
        const users = {};
        data.forEach(r => {
          if (!users[r.code]) users[r.code] = r.role;
        });
        Object.keys(users).forEach(code => {
          const row = tbody.insertRow();
          row.insertCell().textContent = code;
          row.insertCell().textContent = users[code] === 'admin' ? 'Qu·∫£n tr·ªã' : 'Nh√¢n vi√™n';
          const actionCell = row.insertCell();
          actionCell.innerHTML = `
            <button class='btn btn-sm btn-primary me-1' onclick='showEditUserModal("${code}", "${users[code]}")'>S·ª≠a</button>
            <button class='btn btn-sm btn-danger' onclick='deleteUser("${code}")'>X√≥a</button>
          `;
        });
      });
    }

    function showEditUserModal(code, role) {
      document.getElementById('editUserCode').value = code;
      document.getElementById('editUserPin').value = '';
      document.getElementById('editUserRole').value = role;
      var modal = new bootstrap.Modal(document.getElementById('editUserModal'));
      modal.show();
    }

    function saveEditUser() {
      const code = document.getElementById('editUserCode').value;
      const pin = document.getElementById('editUserPin').value;
      const role = document.getElementById('editUserRole').value;
      const data = {};
      if (pin) data.pin = pin;
      data.role = role;
      fetch(`${SHEET_API}/code/${code}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: [data] })
      })
        .then(res => res.json())
        .then(() => {
          alert('ƒê√£ c·∫≠p nh·∫≠t t√†i kho·∫£n!');
          renderUserList();
          var modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
          modal.hide();
        });
    }

    function deleteUser(code) {
      if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√¢n vi√™n n√†y?')) return;
      fetch(`${SHEET_API}/code/${code}`, {
        method: 'DELETE'
      })
        .then(res => res.json())
        .then(() => {
          alert('ƒê√£ x√≥a nh√¢n vi√™n!');
          renderUserList();
        });
    }

    function showAddRecordModal() {
      document.getElementById('manualCode').value = '';
      document.getElementById('manualCheckIn').value = '';
      document.getElementById('manualCheckOut').value = '';
      var modal = new bootstrap.Modal(document.getElementById('addRecordModal'));
      modal.show();
    }

    function addManualRecord() {
      const code = document.getElementById('manualCode').value.trim();
      const checkIn = document.getElementById('manualCheckIn').value;
      const checkOut = document.getElementById('manualCheckOut').value;
      if (!code || !checkIn || !checkOut) {
        alert('Nh·∫≠p ƒë·ªß th√¥ng tin!');
        return;
      }
      fetch(SHEET_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: [{ code, checkIn: new Date(checkIn).toISOString(), checkOut: new Date(checkOut).toISOString() }] })
      })
        .then(res => res.json())
        .then(() => {
          renderTable();
          alert('‚úÖ ƒê√£ th√™m ch·∫•m c√¥ng b√π!');
          var modal = bootstrap.Modal.getInstance(document.getElementById('addRecordModal'));
          modal.hide();
        })
        .catch(() => alert('L·ªói khi th√™m ch·∫•m c√¥ng b√π!'));
    }

    function saveLoginLog(code, lat, lon) {
      fetch(SHEET_API_LOGINLOGS, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: [{ code, loginTime: new Date().toISOString(), lat, lon }] })
      });
    }

    function renderLoginLogs() {
      const tbody = document.getElementById('loginLogsTable');
      tbody.innerHTML = '';
      fetch(SHEET_API_LOGINLOGS)
        .then(res => res.json())
        .then(logs => {
          logs.slice().reverse().forEach(log => {
            const row = tbody.insertRow();
            row.insertCell().textContent = log.code;
            row.insertCell().textContent = new Date(log.loginTime).toLocaleString();
            const cell = row.insertCell();
            if (log.lat && log.lon) {
              cell.textContent = 'ƒêang l·∫•y ƒë·ªãa ch·ªâ...';
              fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${log.lat}&lon=${log.lon}`)
                .then(res => res.json())
                .then(data => {
                  cell.textContent = data.display_name || `${log.lat}, ${log.lon}`;
                })
                .catch(() => {
                  cell.textContent = `${log.lat}, ${log.lon}`;
                });
            } else {
              cell.textContent = 'Kh√¥ng r√µ';
            }
          });
        });
    }

    function renderSummaryTable(year, month) {
      getRecords(data => {
        const monthRecords = filterRecordsByMonth(data, year, month);
        // Gom nh√≥m theo m√£ NV v√† t√≠nh t·ªïng gi·ªù
        const userHours = {};
        monthRecords.forEach(r => {
          if (r.checkIn && r.checkOut) {
            const hours = (new Date(r.checkOut) - new Date(r.checkIn)) / 3600000;
            if (!userHours[r.code]) userHours[r.code] = 0;
            userHours[r.code] += hours;
          }
        });
        // T·∫°o b·∫£ng HTML
        let html = '<table class="table table-bordered"><thead><tr><th>M√£ NV</th><th>T·ªïng gi·ªù trong th√°ng</th></tr></thead><tbody>';
        Object.keys(userHours).forEach(code => {
          html += `<tr><td>${code}</td><td>${userHours[code].toFixed(2)} gi·ªù</td></tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('summaryTableContainer').innerHTML = html;
      });
    }

    // Hi·ªÉn th·ªã giao di·ªán ch√≠nh
    function showMainUI() {
      const session = getSession();
      if (!session) return;
      document.getElementById('loginCard').classList.add('d-none');
      document.getElementById('mainCard').classList.remove('d-none');
      document.getElementById('currentUser').textContent = session.code;
      document.getElementById('currentRole').textContent = session.role;
      if (session.role === 'admin') {
        document.getElementById('adminControls').classList.remove('d-none');
        document.getElementById('createUserCard').classList.remove('d-none');
        document.getElementById('userListCard').classList.remove('d-none');
        document.getElementById('loginHistoryCard').classList.remove('d-none');
        renderUserList();
        renderLoginLogs();
      }
      renderTable();
      // Hi·ªÉn th·ªã t·ªïng gi·ªù th√°ng cho nh√¢n vi√™n
      if (session.role !== 'admin') {
        // Th√™m input ch·ªçn th√°ng cho nh√¢n vi√™n n·∫øu ch∆∞a c√≥
        let pickerRow = document.getElementById('userMonthPickerRow');
        if (!pickerRow) {
          pickerRow = document.createElement('div');
          pickerRow.className = 'row mb-2';
          pickerRow.id = 'userMonthPickerRow';
          pickerRow.innerHTML = `<div class="col-auto"><input type="month" id="userMonthPicker" class="form-control"></div>`;
          document.getElementById('mainCard').prepend(pickerRow);
        }
        // ƒê·∫∑t gi√° tr·ªã m·∫∑c ƒë·ªãnh
        const userMonthPicker = document.getElementById('userMonthPicker');
        if (userMonthPicker && !userMonthPicker.value) {
          const now = new Date();
          userMonthPicker.value = now.toISOString().slice(0, 7);
        }
        function updateUserTotalHours() {
          const picker = document.getElementById('userMonthPicker');
          let year, month;
          if (picker && picker.value) {
            [year, month] = picker.value.split('-').map(Number);
          } else {
            const now = new Date();
            year = now.getFullYear();
            month = now.getMonth() + 1;
          }
          getRecords(data => {
            const monthRecords = filterRecordsByMonth(data.filter(r => r.code === session.code), year, month);
            let total = 0;
            monthRecords.forEach(r => {
              if (r.checkIn && r.checkOut) {
                total += (new Date(r.checkOut) - new Date(r.checkIn)) / 3600000;
              }
            });
            // Th√™m d√≤ng hi·ªÉn th·ªã t·ªïng gi·ªù
            let infoDiv = document.getElementById('totalHoursInfo');
            if (!infoDiv) {
              infoDiv = document.createElement('div');
              infoDiv.id = 'totalHoursInfo';
              infoDiv.className = 'alert alert-info mt-2';
              pickerRow.after(infoDiv);
            }
            infoDiv.textContent = `T·ªïng s·ªë gi·ªù l√†m trong th√°ng ${month}/${year}: ${total.toFixed(2)} gi·ªù`;
          });
        }
        if (userMonthPicker) {
          userMonthPicker.onchange = updateUserTotalHours;
        }
        updateUserTotalHours();
      }
    }

    window.onload = () => {
      if (getSession()) {
        showMainUI();
      }
      // ƒê·∫∑t gi√° tr·ªã m·∫∑c ƒë·ªãnh cho monthPicker
      const monthPicker = document.getElementById('monthPicker');
      if (monthPicker) {
        const now = new Date();
        monthPicker.value = now.toISOString().slice(0, 7);
        // G·ªçi b·∫£ng t·ªïng h·ª£p l·∫ßn ƒë·∫ßu
        let [year, month] = monthPicker.value.split('-').map(Number);
        renderSummaryTable(year, month);
        monthPicker.onchange = function () {
          let [year, month] = monthPicker.value.split('-').map(Number);
          renderSummaryTable(year, month);
        };
      }
    };
  </script>
</body>

</html>