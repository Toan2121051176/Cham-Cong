<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Hệ thống chấm công</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    body {
      background: #f0f2f5;
      padding-top: 40px;
    }

    .card {
      border-radius: 16px;
    }
  </style>
</head>

<body>

  <div class="container">

    <!-- 🔐 Đăng nhập -->
    <div class="card shadow p-4 mb-4" id="loginCard">
      <h4>🔐 Đăng nhập</h4>
      <div class="row">
        <div class="col-md-4"><input id="loginCode" class="form-control" placeholder="Mã nhân viên"></div>
        <div class="col-md-4"><input type="password" id="loginPin" class="form-control" placeholder="Mật khẩu/PIN">
        </div>
        <div class="col-md-4"><button onclick="login()" class="btn btn-primary w-100">Đăng nhập</button></div>
      </div>
    </div>

    <!-- ➕ Tạo tài khoản -->
    <div class="card shadow p-4 mb-4 d-none" id="createUserCard">
      <h4>➕ Tạo tài khoản mới (chỉ Admin)</h4>
      <div class="row g-2">
        <div class="col-md-3"><input id="newCode" class="form-control" placeholder="Mã NV"></div>
        <div class="col-md-3"><input type="password" id="newPin" class="form-control" placeholder="Mật khẩu"></div>
        <div class="col-md-3">
          <select id="newRole" class="form-select">
            <option value="staff">Nhân viên</option>
            <option value="admin">Quản trị</option>
          </select>
        </div>
        <div class="col-md-3"><button onclick="createUser()" class="btn btn-success w-100">Tạo</button></div>
      </div>
    </div>

    <!-- 👥 Danh sách nhân viên (chỉ admin) -->
    <div class="card shadow p-4 mb-4 d-none" id="userListCard">
      <h4>👥 Danh sách nhân viên</h4>
      <div class="table-responsive">
        <table class="table table-bordered mt-3">
          <thead class="table-light">
            <tr>
              <th>Mã NV</th>
              <th>Quyền</th>
              <th>Hành động</th>
            </tr>
          </thead>
          <tbody id="userListTable"></tbody>
        </table>
      </div>
    </div>

    <!-- ⏱️ Giao diện chính -->
    <div class="card shadow p-4 mb-4 d-none" id="mainCard">
      <h4>📅 Chấm công</h4>
      <div class="row mb-3">
        <div class="col-md-4"><strong>Mã NV:</strong> <span id="currentUser"></span></div>
        <div class="col-md-4"><strong>Quyền:</strong> <span id="currentRole"></span></div>
        <div class="col-md-4 text-end">
          <button onclick="logout()" class="btn btn-outline-danger btn-sm">Đăng xuất</button>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-6"><button onclick="checkIn()" class="btn btn-success w-100">✅ Check-in</button></div>
        <div class="col-md-6"><button onclick="checkOut()" class="btn btn-danger w-100">⛔ Check-out</button></div>
      </div>
      <div id="adminControls" class="d-none mb-3">
        <button onclick="exportToExcel()" class="btn btn-primary">📥 Xuất Excel</button>
        <button onclick="showAddRecordModal()" class="btn btn-warning ms-2">➕ Chấm công bù</button>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered mt-3" id="attendanceTable">
          <thead class="table-light">
            <tr>
              <th>Mã NV</th>
              <th>Check-in</th>
              <th>Check-out</th>
              <th>Tổng giờ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- 🕓 Lịch sử đăng nhập -->
    <div id="loginHistoryCard" class="card shadow p-4 mt-4 d-none">
      <h5>🕓 Lịch sử đăng nhập</h5>
      <div class="table-responsive">
        <table class="table table-bordered mt-3">
          <thead class="table-light">
            <tr>
              <th>Mã NV</th>
              <th>Thời gian đăng nhập</th>
              <th>Vị trí (lat, lon)</th>
            </tr>
          </thead>
          <tbody id="loginLogsTable"></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Modal Chấm công bù -->
  <div class="modal fade" id="addRecordModal" tabindex="-1" aria-labelledby="addRecordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addRecordModalLabel">➕ Chấm công bù</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <input id="manualCode" class="form-control" placeholder="Mã NV">
          </div>
          <div class="mb-2">
            <label>Check-in:</label>
            <input id="manualCheckIn" type="datetime-local" class="form-control">
          </div>
          <div class="mb-2">
            <label>Check-out:</label>
            <input id="manualCheckOut" type="datetime-local" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          <button type="button" class="btn btn-success" onclick="addManualRecord()">Lưu</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SHEET_API = 'https://sheetdb.io/api/v1/27oigr7cnxz2f';

    function getUsers(callback) {
      fetch(SHEET_API)
        .then(res => res.json())
        .then(data => callback(data));
    }

    function saveUsers(users) {
      // SheetDB không có hàm save, nên không cần thiết
    }

    function login() {
      const code = document.getElementById('loginCode').value.trim();
      const pin = document.getElementById('loginPin').value.trim();

      fetch(`${SHEET_API}/search?code=${code}&pin=${pin}`)
        .then(res => res.json())
        .then(data => {
          if (data.length === 0) {
            alert("Sai mã hoặc mật khẩu!");
            return;
          }
          // Lưu session vào localStorage (chỉ để nhớ trạng thái đăng nhập)
          localStorage.setItem('session', JSON.stringify({ code, role: data[0].role }));
          showMainUI();
        });
    }

    function saveLoginLog(code, lat, lon) {
      // SheetDB không có hàm save, nên không cần thiết
    }

    function finishLogin(code, role) {
      // SheetDB không có hàm save, nên không cần thiết
    }

    function createUser() {
      const code = document.getElementById('newCode').value.trim();
      const pin = document.getElementById('newPin').value.trim();
      const role = document.getElementById('newRole').value;
      if (!code || !pin) return alert("Nhập đủ thông tin!");

      // Kiểm tra trùng mã NV
      fetch(`${SHEET_API}/search?code=${code}`)
        .then(res => res.json())
        .then(data => {
          if (data.length > 0) {
            alert("Mã NV đã tồn tại!");
          } else {
            fetch(SHEET_API, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ data: [{ code, pin, role }] })
            })
              .then(res => res.json())
              .then(() => alert('✅ Tạo thành công!'))
              .catch(() => alert('Lỗi khi tạo tài khoản!'));
          }
        });
    }

    function logout() {
      localStorage.removeItem('session');
      location.reload();
    }

    function getSession() {
      return JSON.parse(localStorage.getItem('session'));
    }

    function getRecords(callback) {
      fetch(SHEET_API)
        .then(res => res.json())
        .then(data => callback(data));
    }

    function saveRecords(records) {
      // SheetDB không có hàm save, nên không cần thiết
    }

    function checkIn() {
      const session = getSession();
      const checkIn = new Date().toISOString();
      fetch(SHEET_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: [{ code: session.code, checkIn }] })
      })
        .then(res => res.json())
        .then(() => {
          renderTable();
          alert('✅ Check-in thành công!');
        })
        .catch(() => alert('Lỗi khi check-in!'));
    }

    function checkOut() {
      const session = getSession();
      let records = []; // SheetDB không có hàm lấy tất cả records, nên phải lấy lại
      getRecords(data => {
        records = data.filter(r => r.code === session.code && !r.checkOut);
        if (records.length === 0) {
          alert("Chưa check-in!");
          return;
        }
        const record = records[0];
        record.checkOut = new Date().toISOString();
        fetch(SHEET_API, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data: [{ ...record }] })
        })
          .then(res => res.json())
          .then(() => {
            renderTable();
            alert('⛔ Check-out thành công!');
          })
          .catch(() => alert('Lỗi khi check-out!'));
      });
    }

    function renderTable() {
      const tbody = document.querySelector("#attendanceTable tbody");
      tbody.innerHTML = "";
      const session = getSession();
      let records = []; // SheetDB không có hàm lấy tất cả records, nên phải lấy lại
      getRecords(data => {
        records = data.filter(r => r.code === session.code);

        records.forEach(r => {
          const row = tbody.insertRow();
          row.insertCell().textContent = r.code;
          row.insertCell().textContent = r.checkIn ? new Date(r.checkIn).toLocaleString() : '';
          row.insertCell().textContent = r.checkOut ? new Date(r.checkOut).toLocaleString() : '';
          row.insertCell().textContent =
            (r.checkIn && r.checkOut) ?
              ((new Date(r.checkOut) - new Date(r.checkIn)) / 3600000).toFixed(2) + " giờ" : '';
        });
      });
    }

    function exportToExcel() {
      const session = getSession();
      if (!session || session.role !== 'admin') return;
      let records = []; // SheetDB không có hàm lấy tất cả records, nên phải lấy lại
      getRecords(data => {
        records = data.filter(r => r.code === session.code);
        const data = records.map(r => ({
          'Mã NV': r.code,
          'Check-in': r.checkIn ? new Date(r.checkIn).toLocaleString() : '',
          'Check-out': r.checkOut ? new Date(r.checkOut).toLocaleString() : '',
          'Tổng giờ': (r.checkIn && r.checkOut)
            ? ((new Date(r.checkOut) - new Date(r.checkIn)) / 3600000).toFixed(2)
            : ''
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ChamCong");
        XLSX.writeFile(wb, "chamcong.xlsx");
      });
    }

    function renderLoginLogs() {
      const tbody = document.getElementById("loginLogsTable");
      tbody.innerHTML = "";
      // SheetDB không có hàm lấy lịch sử đăng nhập, nên không thể hiển thị
    }

    function renderUserList() {
      const tbody = document.getElementById('userListTable');
      tbody.innerHTML = '';
      // SheetDB không có hàm lấy danh sách nhân viên, nên không thể hiển thị
    }

    function deleteUser(code) {
      if (!confirm('Bạn có chắc muốn xóa nhân viên này?')) return;
      // SheetDB không có hàm xóa, nên không thể thực hiện
      alert('Xóa nhân viên không thể thực hiện được với SheetDB.');
    }

    function showMainUI() {
      const session = getSession();
      if (!session) return;
      document.getElementById('loginCard').classList.add('d-none');
      document.getElementById('mainCard').classList.remove('d-none');
      document.getElementById('currentUser').textContent = session.code;
      document.getElementById('currentRole').textContent = session.role;
      if (session.role === 'admin') {
        document.getElementById('adminControls').classList.remove('d-none');
        document.getElementById('createUserCard').classList.remove('d-none');
        document.getElementById('loginHistoryCard').classList.remove('d-none');
        document.getElementById('userListCard').classList.remove('d-none');
        renderLoginLogs();
        renderUserList();
      }
      renderTable();
    }

    function showAddRecordModal() {
      document.getElementById('manualCode').value = '';
      document.getElementById('manualCheckIn').value = '';
      document.getElementById('manualCheckOut').value = '';
      var modal = new bootstrap.Modal(document.getElementById('addRecordModal'));
      modal.show();
    }

    function addManualRecord() {
      const code = document.getElementById('manualCode').value.trim();
      const checkIn = document.getElementById('manualCheckIn').value;
      const checkOut = document.getElementById('manualCheckOut').value;
      if (!code || !checkIn || !checkOut) {
        alert('Nhập đủ thông tin!');
        return;
      }
      const users = []; // SheetDB không có hàm lấy danh sách users, nên không thể kiểm tra
      if (users.length === 0) { // SheetDB không có hàm lấy danh sách users, nên không thể kiểm tra
        alert('Mã NV không tồn tại!');
        return;
      }
      let records = []; // SheetDB không có hàm lấy tất cả records, nên phải lấy lại
      getRecords(data => {
        records = data.filter(r => r.code === code);
        if (records.length > 0) {
          alert('Mã NV đã tồn tại!');
          return;
        }
        fetch(SHEET_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data: [{ code, checkIn: new Date(checkIn).toISOString(), checkOut: new Date(checkOut).toISOString() }] })
        })
          .then(res => res.json())
          .then(() => {
            renderTable();
            alert('✅ Đã thêm chấm công bù!');
            var modal = bootstrap.Modal.getInstance(document.getElementById('addRecordModal'));
            modal.hide();
          })
          .catch(() => alert('Lỗi khi thêm chấm công bù!'));
      });
    }

    window.onload = () => {
      // SheetDB không có hàm lấy danh sách users, nên không thể kiểm tra
      if (getSession()) {
        showMainUI();
      }
    };
  </script>

</body>

</html>