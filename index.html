<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Há»‡ thá»‘ng cháº¥m cÃ´ng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    body { background: #f0f2f5; padding-top: 40px; }
    .card { border-radius: 16px; }
  </style>
</head>
<body>

<div class="container">

  <!-- ğŸ” ÄÄƒng nháº­p -->
  <div class="card shadow p-4 mb-4" id="loginCard">
    <h4>ğŸ” ÄÄƒng nháº­p</h4>
    <div class="row">
      <div class="col-md-4"><input id="loginCode" class="form-control" placeholder="MÃ£ nhÃ¢n viÃªn"></div>
      <div class="col-md-4"><input type="password" id="loginPin" class="form-control" placeholder="Máº­t kháº©u/PIN"></div>
      <div class="col-md-4"><button onclick="login()" class="btn btn-primary w-100">ÄÄƒng nháº­p</button></div>
    </div>
  </div>

  <!-- â• Táº¡o tÃ i khoáº£n -->
  <div class="card shadow p-4 mb-4 d-none" id="createUserCard">
    <h4>â• Táº¡o tÃ i khoáº£n má»›i (chá»‰ Admin)</h4>
    <div class="row g-2">
      <div class="col-md-3"><input id="newCode" class="form-control" placeholder="MÃ£ NV"></div>
      <div class="col-md-3"><input type="password" id="newPin" class="form-control" placeholder="Máº­t kháº©u"></div>
      <div class="col-md-3">
        <select id="newRole" class="form-select">
          <option value="staff">NhÃ¢n viÃªn</option>
          <option value="admin">Quáº£n trá»‹</option>
        </select>
      </div>
      <div class="col-md-3"><button onclick="createUser()" class="btn btn-success w-100">Táº¡o</button></div>
    </div>
  </div>

  <!-- â±ï¸ Giao diá»‡n chÃ­nh -->
  <div class="card shadow p-4 mb-4 d-none" id="mainCard">
    <h4>ğŸ“… Cháº¥m cÃ´ng</h4>
    <div class="row mb-3">
      <div class="col-md-4"><strong>MÃ£ NV:</strong> <span id="currentUser"></span></div>
      <div class="col-md-4"><strong>Quyá»n:</strong> <span id="currentRole"></span></div>
      <div class="col-md-4 text-end">
        <button onclick="logout()" class="btn btn-outline-danger btn-sm">ÄÄƒng xuáº¥t</button>
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-6"><button onclick="checkIn()" class="btn btn-success w-100">âœ… Check-in</button></div>
      <div class="col-md-6"><button onclick="checkOut()" class="btn btn-danger w-100">â›” Check-out</button></div>
    </div>
    <div id="adminControls" class="d-none mb-3">
      <button onclick="exportToExcel()" class="btn btn-primary">ğŸ“¥ Xuáº¥t Excel</button>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered mt-3" id="attendanceTable">
        <thead class="table-light"><tr><th>MÃ£ NV</th><th>Check-in</th><th>Check-out</th><th>Tá»•ng giá»</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ğŸ•“ Lá»‹ch sá»­ Ä‘Äƒng nháº­p -->
  <div id="loginHistoryCard" class="card shadow p-4 mt-4 d-none">
    <h5>ğŸ•“ Lá»‹ch sá»­ Ä‘Äƒng nháº­p</h5>
    <div class="table-responsive">
      <table class="table table-bordered mt-3">
        <thead class="table-light"><tr><th>MÃ£ NV</th><th>Thá»i gian Ä‘Äƒng nháº­p</th><th>Vá»‹ trÃ­ (lat, lon)</th></tr></thead>
        <tbody id="loginLogsTable"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
  function getUsers() {
    return JSON.parse(localStorage.getItem('users')) || {};
  }
  function saveUsers(users) {
    localStorage.setItem('users', JSON.stringify(users));
  }

  function login() {
    const code = document.getElementById('loginCode').value.trim();
    const pin = document.getElementById('loginPin').value.trim();
    const users = getUsers();

    if (!users[code] || users[code].pin !== pin) {
      alert("Sai mÃ£ hoáº·c máº­t kháº©u!");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const coords = pos.coords;
        saveLoginLog(code, coords.latitude, coords.longitude);
        finishLogin(code, users[code].role);
      },
      (err) => {
        alert("âš ï¸ KhÃ´ng láº¥y Ä‘Æ°á»£c vá»‹ trÃ­. Váº«n tiáº¿p tá»¥c Ä‘Äƒng nháº­p.");
        saveLoginLog(code, null, null);
        finishLogin(code, users[code].role);
      }
    );
  }

  function saveLoginLog(code, lat, lon) {
    let logs = JSON.parse(localStorage.getItem('loginLogs')) || [];
    logs.push({
      code,
      loginTime: new Date().toISOString(),
      lat,
      lon
    });
    localStorage.setItem('loginLogs', JSON.stringify(logs));
  }

  function finishLogin(code, role) {
    localStorage.setItem('session', JSON.stringify({ code, role }));
    showMainUI();
  }

  function createUser() {
    const code = document.getElementById('newCode').value.trim();
    const pin = document.getElementById('newPin').value.trim();
    const role = document.getElementById('newRole').value;
    if (!code || !pin) return alert("Nháº­p Ä‘á»§ thÃ´ng tin!");
    const users = getUsers();
    if (users[code]) return alert("MÃ£ NV Ä‘Ã£ tá»“n táº¡i!");
    users[code] = { pin, role };
    saveUsers(users);
    alert("âœ… Táº¡o thÃ nh cÃ´ng!");
  }

  function logout() {
    localStorage.removeItem('session');
    location.reload();
  }

  function getSession() {
    return JSON.parse(localStorage.getItem('session'));
  }

  function getRecords() {
    return JSON.parse(localStorage.getItem('attendance')) || [];
  }

  function saveRecords(records) {
    localStorage.setItem('attendance', JSON.stringify(records));
  }

  function checkIn() {
    const session = getSession();
    let records = getRecords();
    const latest = records.reverse().find(r => r.code === session.code && !r.checkOut);
    if (latest) return alert("ÄÃ£ check-in!");
    records.push({ code: session.code, checkIn: new Date().toISOString(), checkOut: null });
    saveRecords(records.reverse());
    renderTable();
    alert("âœ… Check-in thÃ nh cÃ´ng!");
  }

  function checkOut() {
    const session = getSession();
    let records = getRecords();
    const record = records.find(r => r.code === session.code && !r.checkOut);
    if (!record) return alert("ChÆ°a check-in!");
    record.checkOut = new Date().toISOString();
    saveRecords(records);
    renderTable();
    alert("â›” Check-out thÃ nh cÃ´ng!");
  }

  function renderTable() {
    const tbody = document.querySelector("#attendanceTable tbody");
    tbody.innerHTML = "";
    const session = getSession();
    const records = getRecords();
    const visible = (session.role === 'admin') ? records : records.filter(r => r.code === session.code);

    visible.forEach(r => {
      const row = tbody.insertRow();
      row.insertCell().textContent = r.code;
      row.insertCell().textContent = r.checkIn ? new Date(r.checkIn).toLocaleString() : '';
      row.insertCell().textContent = r.checkOut ? new Date(r.checkOut).toLocaleString() : '';
      row.insertCell().textContent =
        (r.checkIn && r.checkOut) ?
        ((new Date(r.checkOut) - new Date(r.checkIn)) / 3600000).toFixed(2) + " giá»" : '';
    });
  }

  function exportToExcel() {
    const session = getSession();
    if (!session || session.role !== 'admin') return;
    const records = getRecords();
    const data = records.map(r => ({
      'MÃ£ NV': r.code,
      'Check-in': r.checkIn ? new Date(r.checkIn).toLocaleString() : '',
      'Check-out': r.checkOut ? new Date(r.checkOut).toLocaleString() : '',
      'Tá»•ng giá»': (r.checkIn && r.checkOut)
        ? ((new Date(r.checkOut) - new Date(r.checkIn)) / 3600000).toFixed(2)
        : ''
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ChamCong");
    XLSX.writeFile(wb, "chamcong.xlsx");
  }

  function renderLoginLogs() {
    const tbody = document.getElementById("loginLogsTable");
    tbody.innerHTML = "";
    const logs = JSON.parse(localStorage.getItem('loginLogs')) || [];
    logs.slice().reverse().forEach(log => {
      const row = tbody.insertRow();
      row.insertCell().textContent = log.code;
      row.insertCell().textContent = new Date(log.loginTime).toLocaleString();
      row.insertCell().textContent = (log.lat && log.lon)
        ? `${log.lat.toFixed(6)}, ${log.lon.toFixed(6)}`
        : "KhÃ´ng rÃµ";
    });
  }

  function showMainUI() {
    const session = getSession();
    if (!session) return;
    document.getElementById('loginCard').classList.add('d-none');
    document.getElementById('mainCard').classList.remove('d-none');
    document.getElementById('currentUser').textContent = session.code;
    document.getElementById('currentRole').textContent = session.role;
    if (session.role === 'admin') {
      document.getElementById('adminControls').classList.remove('d-none');
      document.getElementById('createUserCard').classList.remove('d-none');
      document.getElementById('loginHistoryCard').classList.remove('d-none');
      renderLoginLogs();
    }
    renderTable();
  }

  window.onload = () => {
    const users = getUsers();
    if (!users['admin']) {
      users['admin'] = { pin: 'admin', role: 'admin' };
      saveUsers(users);
    }
    if (getSession()) {
      showMainUI();
    }
  };
</script>

</body>
</html>
